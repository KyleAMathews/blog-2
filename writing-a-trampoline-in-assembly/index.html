<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Writing a &#x27;trampoline&#x27; in assembly for profiling</title><meta name="description" content="I&#x27;m a Software Engineer. I like programming languages, VMs &amp; compilers. I work at Uber. I did some React Native stuff at Facebook."/><link rel="author" href="https://plus.google.com/+TadeuZagallo?rel=author"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@tadeuzagallo"/><meta name="twitter:title" content="Writing a &#x27;trampoline&#x27; in assembly for profiling"/><meta name="twitter:description" content="I&#x27;m a Software Engineer. I like programming languages, VMs &amp; compilers. I work at Uber. I did some React Native stuff at Facebook."/><meta property="twitter:image:src" content="https://tadeuzagallo.com/blog/12790c3e14a70c6efd91375148aaf0ba.jpg"/><meta property="og:url" content="https://tadeuzagallo.com/blog/writing-a-trampoline-in-assembly/"/><meta property="og:title" content="Writing a &#x27;trampoline&#x27; in assembly for profiling"/><meta property="og:image" content="https://tadeuzagallo.com/blog/12790c3e14a70c6efd91375148aaf0ba.jpg"/><meta property="og:description" content="I&#x27;m a Software Engineer. I like programming languages, VMs &amp; compilers. I work at Uber. I did some React Native stuff at Facebook."/><meta property="og:site_name" content="Blog by Tadeu Zagallo"/><meta content="Writing a &#x27;trampoline&#x27; in assembly for profiling"/><meta content="I&#x27;m a Software Engineer. I like programming languages, VMs &amp; compilers. I work at Uber. I did some React Native stuff at Facebook."/><meta content="https://tadeuzagallo.com/blog/12790c3e14a70c6efd91375148aaf0ba.jpg"/><link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAALVBMVEU5Nzc7OTkvLS0/Pj7S0dHh4eEDAgLX19eOjo5IR0e3trYbFxehoKDFxcV/f3/c3dyeAAAA/UlEQVQoz2MQRAMMhoKokAGNb8iAoUVQWNDQEIghCKhFGFUBRAsDFDCCtSD4YBGggABCgAEswMCgBAUKUAFmYxAwFDY2gAgw7ypxAQP3ZQKMYIGsktLw8hIX99BrBmABBs7ZrZ6Wxga24a8hKhiY1FodN21SWxqXyMAIsdas1VmJKSu0zQAmIAYUYDsak8yEJKCQE3oM5g6wFrXWKM2ZkyAqBIECntqu4eXuywygnjNrv6m0BOiw1TABBkkDJmNDRmGo04GGMCmAPMgE9S2QYGQAIVh4IAWRIEwAGkqM0FBHjQZUPijmUCIOGA2GyCLCguC4RQbC4KhExKSwIAAsiD+gSXT+sAAAAABJRU5ErkJggg==" type="image/png"/><meta name="theme-color" content="#3e3c3c"/><link href="https://fonts.googleapis.com/css?family=Roboto:400,400italic,500,700&amp;subset=latin" rel="stylesheet" type="text/css"/><style>html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,cite,code,details,figcaption,figure,footer,header,hgroup,main,nav,section,small,summary{display:block}article,article ol,article ul,blockquote,body,div,figure,footer,header,input,nav,section{box-sizing:border-box}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background:transparent}a:active,a:hover{outline:0}abbr{letter-spacing:.1em}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}mark{background:#ff0;color:#000}small{font-size:70%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}em,i{line-height:0;position:relative;vertical-align:baseline}img{border:0}svg:not(:root){overflow:hidden}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}img{max-width:100%;display:block;margin:inherit auto}.wrapper{max-width:1070px;margin-left:auto;margin-right:auto}.wrapper:after,.wrapper:before{content:'';display:table}.wrapper:after{clear:both}.content{width:calc(99.9% * 2/3 - 10px)}.content:nth-child(1n){float:left;margin-right:30px;clear:none}.content:last-child{margin-right:0}.content:nth-child(3n){margin-right:0;float:right}.content:nth-child(3n+1){clear:both}.main-inner{padding:40px 35px}@media screen and (max-width:1100px){.content{width:calc(99.9% * 2/4 - 15px)}.content:nth-child(1n){float:left;margin-right:30px;clear:none}.content:last-child{margin-right:0}.content:nth-child(4n){margin-right:0;float:right}.content:nth-child(4n+1){clear:both}.main-inner{padding:35px 20px}}@media screen and (max-width:900px){.content{width:calc(99.9% * 7/12 - 12.5px)}.content:nth-child(1n){float:left;margin-right:30px;clear:none}.content:last-child{margin-right:0}.content:nth-child(12n){margin-right:0;float:right}.content:nth-child(12n+1){clear:both}.main-inner{padding:30px 20px}}@media screen and (max-width:500px){.content{width:calc(99.9% * 4/4 - 0px)}.content:nth-child(1n){float:left;margin-right:30px;clear:none}.content:last-child{margin-right:0}.content:nth-child(4n){margin-right:0;float:right}.content:nth-child(4n+1){clear:both}.main-inner{padding:25px 20px}}@media screen and (min-width:40em){.floatLeft{float:left}}@media screen and (min-width:40em){.floatCenter{margin-left:auto;margin-right:auto}}@media screen and (min-width:40em){.floatRight{float:right}}@media screen and (min-width:40em){body,html{margin:0;width:100%;max-width:none}}html{box-sizing:border-box;font-size:16px;font-size:100%;font-family:Roboto,Arial,sans-serif;color:#222;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}@media screen and (min-width:40em){html{font-size:18px;font-size:1.125rem}}*,:after,:before{box-sizing:inherit}body{margin:0}footer{display:block}body>footer{margin:0 auto;width:80%}header,main,section{display:block}a{background:transparent;color:#222;text-decoration:none;-webkit-transition:all .3s;transition:all .3s}a:active,a:hover{outline:0}a:active,a:hover{color:#222}article{display:block;margin:0 auto;width:80%}@media screen and (min-width:40em){article{max-width:945px;max-width:52.5rem}}audio{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}canvas{display:inline-block;vertical-align:baseline}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace}code{display:inline-block}details,figcaption,summary{display:block}figcaption{line-height:26px;line-height:1.625rem;color:#222;font-size:.8125rem;font-style:italic;margin-bottom:0;text-align:center}@media screen and (min-width:40em){figcaption{line-height:31px;line-height:1.722222222222222rem;margin-bottom:0}}figure{display:block}@media screen and (min-width:40em){figure.floatLeft,figure.floatRight{max-width:315px;max-width:17.5rem;padding:0 31px;padding:0 1.722222222222222rem}}@media screen and (min-width:40em){figure.floatLeft blockquote,figure.floatRight blockquote{padding:0;text-align:left}}@media screen and (min-width:40em){figure.floatLeft blockquote p,figure.floatRight blockquote p{font-size:19.2px;font-size:1.2rem;line-height:31px;line-height:1.722222222222222rem}}h1{font-size:40px;font-size:2.5rem;line-height:52px;line-height:3.25rem;margin-top:104px;margin-top:6.5rem;margin-bottom:26px;margin-bottom:1.625rem}h2{font-size:27px;font-size:1.6875rem;line-height:39px;line-height:2.4375rem;margin-top:65px;margin-top:4.0625rem;margin-bottom:13px;margin-bottom:.8125rem}h3{font-size:22px;font-size:1.375rem;margin-top:52px;margin-top:3.25rem}h3,h4{line-height:26px;line-height:1.625rem;margin-bottom:13px;margin-bottom:.8125rem}h4{font-size:19.2px;font-size:1.2rem;margin-top:39px;margin-top:2.4375rem}h5,h6{font-size:16px;font-size:1rem;line-height:26px;line-height:1.625rem;margin-top:65px;margin-top:4.0625rem;margin-bottom:13px;margin-bottom:.8125rem}@media screen and (min-width:40em){h1{font-size:40px;font-size:2.5rem;line-height:62px;line-height:3.444444444444445rem;margin-top:124px;margin-top:6.888888888888889rem;margin-bottom:31px;margin-bottom:1.722222222222222rem}h2{font-size:27px;font-size:1.6875rem;line-height:46.5px;line-height:2.583333333333334rem;margin-top:77.5px;margin-top:4.305555555555556rem;margin-bottom:15.5px;margin-bottom:.861111111111111rem}h3{font-size:22px;font-size:1.375rem;margin-top:62px;margin-top:3.444444444444445rem}h3,h4{line-height:31px;line-height:1.722222222222222rem;margin-bottom:15.5px;margin-bottom:.861111111111111rem}h4{font-size:19.2px;font-size:1.2rem;margin-top:46.5px;margin-top:2.583333333333334rem}h5,h6{font-size:16px;font-size:1rem;line-height:31px;line-height:1.722222222222222rem;margin-top:77.5px;margin-top:4.305555555555556rem;margin-bottom:15.5px;margin-bottom:.861111111111111rem}}h1+h2{margin-top:26px;margin-top:1.625rem}@media screen and (min-width:40em){h1+h2{margin-top:31px;margin-top:1.722222222222222rem}}h2+h3,h3+h4,h4+h5{margin-top:13px;margin-top:.8125rem}@media screen and (min-width:40em){h2+h3,h3+h4,h4+h5{margin-top:15.5px;margin-top:.861111111111111rem}}h5+h6{margin-top:-13px;margin-top:-.8125rem}@media screen and (min-width:40em){h5+h6{margin-top:-15.5px;margin-top:-.861111111111111rem}}h6{font-style:italic;font-weight:400}hgroup,hr{display:block}hr{margin-top:52px;margin-bottom:52px;box-sizing:content-box;border:0;color:#222;height:26px;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-size:100% 1.625rem;background-image:-webkit-linear-gradient(top,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:100px}@media screen and (min-width:40em){hr{background-size:100% 31px;background-size:100% 1.722222222222222rem;background-image:-webkit-linear-gradient(top,transparent 1px,transparent 13.5px,#222 0,#222 17.5px,transparent 0,transparent 31px);background-image:linear-gradient(180deg,transparent 1px,transparent 13.5px,#222 0,#222 17.5px,transparent 0,transparent 31px);margin-top:62px;margin-top:3.444444444444445rem;margin-bottom:62px;margin-bottom:3.444444444444445rem;height:31px;height:1.722222222222222rem}}img{border:0;max-width:100%;display:block;margin:inherit auto}svg:not(:root){overflow:hidden}ol li,ul li{margin-bottom:0}nav{display:block}progress{display:inline-block;vertical-align:baseline}blockquote{font-style:italic;padding-left:1.4375rem}@media screen and (min-width:40em){blockquote{padding-left:2rem}}cite{display:block;font-style:normal}figure blockquote{padding:26px 0;padding:1.625rem 0}@media screen and (min-width:40em){figure blockquote{padding:62px 0 31px;padding:3.444444444444445rem 0 1.722222222222222rem;text-align:center}}figure blockquote p{font-size:27px;font-size:1.6875rem;line-height:39px;line-height:2.4375rem}@media screen and (min-width:40em){figure blockquote p{font-size:27px;font-size:1.6875rem;line-height:46.5px;line-height:2.583333333333334rem}}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}[hidden],template{display:none}abbr{letter-spacing:.1em}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}em,i{line-height:0;position:relative;vertical-align:baseline}mark{background:#ff0;color:#000}small{line-height:13px;line-height:.8125rem;font-size:70%}@media screen and (min-width:40em){small{line-height:15.5px;line-height:.861111111111111rem}}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}.attention-grabber{font-size:19.2px;font-size:1.2rem}.alignLeft{text-align:left}.alignCenter{text-align:center}.alignRight{text-align:right}.uppercase{letter-spacing:.1em;text-transform:uppercase}video{display:inline-block;vertical-align:baseline}.description{font-size:calc(12px + 2 * ((100vw - 420px) / 860));line-height:1.6}@media screen and (min-width:1280px){.description{font-size:14px}}@media screen and (max-width:420px){.description{font-size:12px}}.blog-post{margin-bottom:30px}.blog-post:last-child{margin-bottom:10px}.blog-post h2{margin-top:10px;line-height:30px;margin-bottom:20px}.blog-post h2 a:hover{border-bottom:1px solid}.blog-post p{font-size:16px;line-height:26px;margin-bottom:26px}.blog-post time{color:#222}.blog-post .blog-category,.blog-post time{font-size:14px;font-weight:500;text-transform:uppercase}.blog-post .blog-category{color:#f7a046}.blog-post .readmore{font-size:16px;color:#5072b7;border-bottom:1px solid #5072b7}.blog-post .readmore:hover{border-bottom:1px solid}.blog-single .text a{border-bottom:1px solid #000}.blog-single .share i.fa{display:inline-block;margin-left:25px}.blog-single .footer img{display:inline-block;float:left;margin-right:30px;margin-bottom:0;border-radius:5%;background-clip:padding-box}.blog-single{max-width:945px;margin-left:auto;margin-right:auto}.blog-single h1{text-align:center;margin-top:30px}.blog-single .text{line-height:31px;margin-bottom:31px}.blog-single .text small{font-size:.82em;line-height:1.5em}.blog-single .date-published,.blog-single .text :not(div),.blog-single h1{max-width:800px;margin-left:auto;margin-right:auto}.blog-single .date-published{text-align:center;line-height:0;font-size:.9em;color:#666}.blog-single .text img{max-width:100%;height:auto}.blog-single .footer{max-width:630px;margin-left:auto;margin-right:auto;line-height:31px;margin-bottom:31px}.gohome{position:fixed;left:20px;font-size:16px;text-align:center;padding:8px 16px;color:#999;background:#f4f4f4;font-weight:400;border-radius:3px}.gohome:focus,.gohome:hover{color:#444;background:#f4f4f4;border:0}@media (max-width:900px){.blog-single h1{margin-top:15px}.blog-single .footer,.blog-single .text{padding:0 15px;line-height:26px;margin-bottom:26px}.gohome{position:static;margin:20px auto 0;text-align:center;width:85px;display:block}}code{white-space:pre;word-wrap:break-word;display:inline;font-family:Inconsolata,monospace,serif;max-width:100%;overflow:auto;padding:.25em .5em}code,pre code{border-radius:3px;background:#f8f8f8}pre code{display:block;overflow-x:auto;padding:.5em 1em;color:#333}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.blog-nav{margin:20px 0 10px}.blog-nav hr{height:1px;background:-webkit-linear-gradient(left,#eee,#eee 48%,#fff);background:linear-gradient(90deg,#eee 0,#eee 48%,#fff);width:100%;margin:10px 0}.blog-nav ul{list-style:none;padding-left:0}.blog-nav ul li{margin:10px 0}.blog-nav ul li a{font-size:16px;line-heigh:26px;margin-bottom:26px;border-bottom:0;font-weight:400;color:#222}.blog-nav ul li a.current,.blog-nav ul li a:hover{border-bottom:1px solid}.blog-social{margin-top:30px}.blog-social ul:after,.blog-social ul:before{content:' ';display:table}.blog-social ul:after{clear:both}.blog-social ul{list-style:none;padding:0;margin:10px 0;zoom:1}.blog-social ul>li{float:left;margin-right:5px;text-align:center;height:24px;width:24px;border-radius:3px;background:#f4f4f4}.blog-social ul>li:hover{background:#f4f4f4}.blog-social ul>li>a{border-bottom:0}.blog-social ul>li>a>i{color:#606060;font-size:14px;line-height:24px}.blog-social ul>li:hover a>i{color:#444}/*!
 *  Font Awesome 4.5.0 by @davegandy - http://fontawesome.io - @fontawesome
 *  License - http://fontawesome.io/license (Font: SIL OFL 1.1, CSS: MIT License)
 */@font-face{font-family:FontAwesome;src:url(/blog/32400f4e08932a94d8bfd2422702c446.eot);src:url(/blog/32400f4e08932a94d8bfd2422702c446.eot?#iefix&v=4.5.0) format('embedded-opentype'),url(/blog/db812d8a70a4e88e888744c1c9a27e89.woff2) format('woff2'),url(/blog/a35720c2fed2c7f043bc7e4ffb45e073.woff) format('woff'),url(/blog/a3de2170e4e9df77161ea5d3f31b2668.ttf) format('truetype'),url(data:image/svg+xml;base64,bW9kdWxlLmV4cG9ydHMgPSBfX3dlYnBhY2tfcHVibGljX3BhdGhfXyArICJmNzc1ZjljY2E4OGUyMWQ0NWJlYmUxODViMjdjMGU1Yi5zdmciOw==) format('svg');font-weight:400;font-style:normal}.fa{display:inline-block;font:normal normal normal 14px/1 FontAwesome;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.fa-lg{font-size:1.33333333em;line-height:.75em;vertical-align:-15%}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-fw{width:1.28571429em;text-align:center}.fa-ul{padding-left:0;margin-left:2.14285714em;list-style-type:none}.fa-ul>li{position:relative}.fa-li{position:absolute;left:-2.14285714em;width:2.14285714em;top:.14285714em;text-align:center}.fa-li.fa-lg{left:-1.85714286em}.fa-border{padding:.2em .25em .15em;border:.08em solid #eee;border-radius:.1em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left{margin-right:.3em}.fa.fa-pull-right{margin-left:.3em}.pull-right{float:right}.pull-left{float:left}.fa.pull-left{margin-right:.3em}.fa.pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}.fa-rotate-90{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=1);-webkit-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=2);-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=3);-webkit-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=0,mirror=1);-webkit-transform:scaleX(-1);transform:scaleX(-1)}.fa-flip-vertical{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=2,mirror=1);-webkit-transform:scaleY(-1);transform:scaleY(-1)}:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-rotate-90,:root .fa-rotate-180,:root .fa-rotate-270{-webkit-filter:none;filter:none}.fa-stack{position:relative;display:inline-block;width:2em;height:2em;line-height:2em;vertical-align:middle}.fa-stack-1x,.fa-stack-2x{position:absolute;left:0;width:100%;text-align:center}.fa-stack-1x{line-height:inherit}.fa-stack-2x{font-size:2em}.fa-inverse{color:#fff}.fa-glass:before{content:"\F000"}.fa-music:before{content:"\F001"}.fa-search:before{content:"\F002"}.fa-envelope-o:before{content:"\F003"}.fa-heart:before{content:"\F004"}.fa-star:before{content:"\F005"}.fa-star-o:before{content:"\F006"}.fa-user:before{content:"\F007"}.fa-film:before{content:"\F008"}.fa-th-large:before{content:"\F009"}.fa-th:before{content:"\F00A"}.fa-th-list:before{content:"\F00B"}.fa-check:before{content:"\F00C"}.fa-close:before,.fa-remove:before,.fa-times:before{content:"\F00D"}.fa-search-plus:before{content:"\F00E"}.fa-search-minus:before{content:"\F010"}.fa-power-off:before{content:"\F011"}.fa-signal:before{content:"\F012"}.fa-cog:before,.fa-gear:before{content:"\F013"}.fa-trash-o:before{content:"\F014"}.fa-home:before{content:"\F015"}.fa-file-o:before{content:"\F016"}.fa-clock-o:before{content:"\F017"}.fa-road:before{content:"\F018"}.fa-download:before{content:"\F019"}.fa-arrow-circle-o-down:before{content:"\F01A"}.fa-arrow-circle-o-up:before{content:"\F01B"}.fa-inbox:before{content:"\F01C"}.fa-play-circle-o:before{content:"\F01D"}.fa-repeat:before,.fa-rotate-right:before{content:"\F01E"}.fa-refresh:before{content:"\F021"}.fa-list-alt:before{content:"\F022"}.fa-lock:before{content:"\F023"}.fa-flag:before{content:"\F024"}.fa-headphones:before{content:"\F025"}.fa-volume-off:before{content:"\F026"}.fa-volume-down:before{content:"\F027"}.fa-volume-up:before{content:"\F028"}.fa-qrcode:before{content:"\F029"}.fa-barcode:before{content:"\F02A"}.fa-tag:before{content:"\F02B"}.fa-tags:before{content:"\F02C"}.fa-book:before{content:"\F02D"}.fa-bookmark:before{content:"\F02E"}.fa-print:before{content:"\F02F"}.fa-camera:before{content:"\F030"}.fa-font:before{content:"\F031"}.fa-bold:before{content:"\F032"}.fa-italic:before{content:"\F033"}.fa-text-height:before{content:"\F034"}.fa-text-width:before{content:"\F035"}.fa-align-left:before{content:"\F036"}.fa-align-center:before{content:"\F037"}.fa-align-right:before{content:"\F038"}.fa-align-justify:before{content:"\F039"}.fa-list:before{content:"\F03A"}.fa-dedent:before,.fa-outdent:before{content:"\F03B"}.fa-indent:before{content:"\F03C"}.fa-video-camera:before{content:"\F03D"}.fa-image:before,.fa-photo:before,.fa-picture-o:before{content:"\F03E"}.fa-pencil:before{content:"\F040"}.fa-map-marker:before{content:"\F041"}.fa-adjust:before{content:"\F042"}.fa-tint:before{content:"\F043"}.fa-edit:before,.fa-pencil-square-o:before{content:"\F044"}.fa-share-square-o:before{content:"\F045"}.fa-check-square-o:before{content:"\F046"}.fa-arrows:before{content:"\F047"}.fa-step-backward:before{content:"\F048"}.fa-fast-backward:before{content:"\F049"}.fa-backward:before{content:"\F04A"}.fa-play:before{content:"\F04B"}.fa-pause:before{content:"\F04C"}.fa-stop:before{content:"\F04D"}.fa-forward:before{content:"\F04E"}.fa-fast-forward:before{content:"\F050"}.fa-step-forward:before{content:"\F051"}.fa-eject:before{content:"\F052"}.fa-chevron-left:before{content:"\F053"}.fa-chevron-right:before{content:"\F054"}.fa-plus-circle:before{content:"\F055"}.fa-minus-circle:before{content:"\F056"}.fa-times-circle:before{content:"\F057"}.fa-check-circle:before{content:"\F058"}.fa-question-circle:before{content:"\F059"}.fa-info-circle:before{content:"\F05A"}.fa-crosshairs:before{content:"\F05B"}.fa-times-circle-o:before{content:"\F05C"}.fa-check-circle-o:before{content:"\F05D"}.fa-ban:before{content:"\F05E"}.fa-arrow-left:before{content:"\F060"}.fa-arrow-right:before{content:"\F061"}.fa-arrow-up:before{content:"\F062"}.fa-arrow-down:before{content:"\F063"}.fa-mail-forward:before,.fa-share:before{content:"\F064"}.fa-expand:before{content:"\F065"}.fa-compress:before{content:"\F066"}.fa-plus:before{content:"\F067"}.fa-minus:before{content:"\F068"}.fa-asterisk:before{content:"\F069"}.fa-exclamation-circle:before{content:"\F06A"}.fa-gift:before{content:"\F06B"}.fa-leaf:before{content:"\F06C"}.fa-fire:before{content:"\F06D"}.fa-eye:before{content:"\F06E"}.fa-eye-slash:before{content:"\F070"}.fa-exclamation-triangle:before,.fa-warning:before{content:"\F071"}.fa-plane:before{content:"\F072"}.fa-calendar:before{content:"\F073"}.fa-random:before{content:"\F074"}.fa-comment:before{content:"\F075"}.fa-magnet:before{content:"\F076"}.fa-chevron-up:before{content:"\F077"}.fa-chevron-down:before{content:"\F078"}.fa-retweet:before{content:"\F079"}.fa-shopping-cart:before{content:"\F07A"}.fa-folder:before{content:"\F07B"}.fa-folder-open:before{content:"\F07C"}.fa-arrows-v:before{content:"\F07D"}.fa-arrows-h:before{content:"\F07E"}.fa-bar-chart-o:before,.fa-bar-chart:before{content:"\F080"}.fa-twitter-square:before{content:"\F081"}.fa-facebook-square:before{content:"\F082"}.fa-camera-retro:before{content:"\F083"}.fa-key:before{content:"\F084"}.fa-cogs:before,.fa-gears:before{content:"\F085"}.fa-comments:before{content:"\F086"}.fa-thumbs-o-up:before{content:"\F087"}.fa-thumbs-o-down:before{content:"\F088"}.fa-star-half:before{content:"\F089"}.fa-heart-o:before{content:"\F08A"}.fa-sign-out:before{content:"\F08B"}.fa-linkedin-square:before{content:"\F08C"}.fa-thumb-tack:before{content:"\F08D"}.fa-external-link:before{content:"\F08E"}.fa-sign-in:before{content:"\F090"}.fa-trophy:before{content:"\F091"}.fa-github-square:before{content:"\F092"}.fa-upload:before{content:"\F093"}.fa-lemon-o:before{content:"\F094"}.fa-phone:before{content:"\F095"}.fa-square-o:before{content:"\F096"}.fa-bookmark-o:before{content:"\F097"}.fa-phone-square:before{content:"\F098"}.fa-twitter:before{content:"\F099"}.fa-facebook-f:before,.fa-facebook:before{content:"\F09A"}.fa-github:before{content:"\F09B"}.fa-unlock:before{content:"\F09C"}.fa-credit-card:before{content:"\F09D"}.fa-feed:before,.fa-rss:before{content:"\F09E"}.fa-hdd-o:before{content:"\F0A0"}.fa-bullhorn:before{content:"\F0A1"}.fa-bell:before{content:"\F0F3"}.fa-certificate:before{content:"\F0A3"}.fa-hand-o-right:before{content:"\F0A4"}.fa-hand-o-left:before{content:"\F0A5"}.fa-hand-o-up:before{content:"\F0A6"}.fa-hand-o-down:before{content:"\F0A7"}.fa-arrow-circle-left:before{content:"\F0A8"}.fa-arrow-circle-right:before{content:"\F0A9"}.fa-arrow-circle-up:before{content:"\F0AA"}.fa-arrow-circle-down:before{content:"\F0AB"}.fa-globe:before{content:"\F0AC"}.fa-wrench:before{content:"\F0AD"}.fa-tasks:before{content:"\F0AE"}.fa-filter:before{content:"\F0B0"}.fa-briefcase:before{content:"\F0B1"}.fa-arrows-alt:before{content:"\F0B2"}.fa-group:before,.fa-users:before{content:"\F0C0"}.fa-chain:before,.fa-link:before{content:"\F0C1"}.fa-cloud:before{content:"\F0C2"}.fa-flask:before{content:"\F0C3"}.fa-cut:before,.fa-scissors:before{content:"\F0C4"}.fa-copy:before,.fa-files-o:before{content:"\F0C5"}.fa-paperclip:before{content:"\F0C6"}.fa-floppy-o:before,.fa-save:before{content:"\F0C7"}.fa-square:before{content:"\F0C8"}.fa-bars:before,.fa-navicon:before,.fa-reorder:before{content:"\F0C9"}.fa-list-ul:before{content:"\F0CA"}.fa-list-ol:before{content:"\F0CB"}.fa-strikethrough:before{content:"\F0CC"}.fa-underline:before{content:"\F0CD"}.fa-table:before{content:"\F0CE"}.fa-magic:before{content:"\F0D0"}.fa-truck:before{content:"\F0D1"}.fa-pinterest:before{content:"\F0D2"}.fa-pinterest-square:before{content:"\F0D3"}.fa-google-plus-square:before{content:"\F0D4"}.fa-google-plus:before{content:"\F0D5"}.fa-money:before{content:"\F0D6"}.fa-caret-down:before{content:"\F0D7"}.fa-caret-up:before{content:"\F0D8"}.fa-caret-left:before{content:"\F0D9"}.fa-caret-right:before{content:"\F0DA"}.fa-columns:before{content:"\F0DB"}.fa-sort:before,.fa-unsorted:before{content:"\F0DC"}.fa-sort-desc:before,.fa-sort-down:before{content:"\F0DD"}.fa-sort-asc:before,.fa-sort-up:before{content:"\F0DE"}.fa-envelope:before{content:"\F0E0"}.fa-linkedin:before{content:"\F0E1"}.fa-rotate-left:before,.fa-undo:before{content:"\F0E2"}.fa-gavel:before,.fa-legal:before{content:"\F0E3"}.fa-dashboard:before,.fa-tachometer:before{content:"\F0E4"}.fa-comment-o:before{content:"\F0E5"}.fa-comments-o:before{content:"\F0E6"}.fa-bolt:before,.fa-flash:before{content:"\F0E7"}.fa-sitemap:before{content:"\F0E8"}.fa-umbrella:before{content:"\F0E9"}.fa-clipboard:before,.fa-paste:before{content:"\F0EA"}.fa-lightbulb-o:before{content:"\F0EB"}.fa-exchange:before{content:"\F0EC"}.fa-cloud-download:before{content:"\F0ED"}.fa-cloud-upload:before{content:"\F0EE"}.fa-user-md:before{content:"\F0F0"}.fa-stethoscope:before{content:"\F0F1"}.fa-suitcase:before{content:"\F0F2"}.fa-bell-o:before{content:"\F0A2"}.fa-coffee:before{content:"\F0F4"}.fa-cutlery:before{content:"\F0F5"}.fa-file-text-o:before{content:"\F0F6"}.fa-building-o:before{content:"\F0F7"}.fa-hospital-o:before{content:"\F0F8"}.fa-ambulance:before{content:"\F0F9"}.fa-medkit:before{content:"\F0FA"}.fa-fighter-jet:before{content:"\F0FB"}.fa-beer:before{content:"\F0FC"}.fa-h-square:before{content:"\F0FD"}.fa-plus-square:before{content:"\F0FE"}.fa-angle-double-left:before{content:"\F100"}.fa-angle-double-right:before{content:"\F101"}.fa-angle-double-up:before{content:"\F102"}.fa-angle-double-down:before{content:"\F103"}.fa-angle-left:before{content:"\F104"}.fa-angle-right:before{content:"\F105"}.fa-angle-up:before{content:"\F106"}.fa-angle-down:before{content:"\F107"}.fa-desktop:before{content:"\F108"}.fa-laptop:before{content:"\F109"}.fa-tablet:before{content:"\F10A"}.fa-mobile-phone:before,.fa-mobile:before{content:"\F10B"}.fa-circle-o:before{content:"\F10C"}.fa-quote-left:before{content:"\F10D"}.fa-quote-right:before{content:"\F10E"}.fa-spinner:before{content:"\F110"}.fa-circle:before{content:"\F111"}.fa-mail-reply:before,.fa-reply:before{content:"\F112"}.fa-github-alt:before{content:"\F113"}.fa-folder-o:before{content:"\F114"}.fa-folder-open-o:before{content:"\F115"}.fa-smile-o:before{content:"\F118"}.fa-frown-o:before{content:"\F119"}.fa-meh-o:before{content:"\F11A"}.fa-gamepad:before{content:"\F11B"}.fa-keyboard-o:before{content:"\F11C"}.fa-flag-o:before{content:"\F11D"}.fa-flag-checkered:before{content:"\F11E"}.fa-terminal:before{content:"\F120"}.fa-code:before{content:"\F121"}.fa-mail-reply-all:before,.fa-reply-all:before{content:"\F122"}.fa-star-half-empty:before,.fa-star-half-full:before,.fa-star-half-o:before{content:"\F123"}.fa-location-arrow:before{content:"\F124"}.fa-crop:before{content:"\F125"}.fa-code-fork:before{content:"\F126"}.fa-chain-broken:before,.fa-unlink:before{content:"\F127"}.fa-question:before{content:"\F128"}.fa-info:before{content:"\F129"}.fa-exclamation:before{content:"\F12A"}.fa-superscript:before{content:"\F12B"}.fa-subscript:before{content:"\F12C"}.fa-eraser:before{content:"\F12D"}.fa-puzzle-piece:before{content:"\F12E"}.fa-microphone:before{content:"\F130"}.fa-microphone-slash:before{content:"\F131"}.fa-shield:before{content:"\F132"}.fa-calendar-o:before{content:"\F133"}.fa-fire-extinguisher:before{content:"\F134"}.fa-rocket:before{content:"\F135"}.fa-maxcdn:before{content:"\F136"}.fa-chevron-circle-left:before{content:"\F137"}.fa-chevron-circle-right:before{content:"\F138"}.fa-chevron-circle-up:before{content:"\F139"}.fa-chevron-circle-down:before{content:"\F13A"}.fa-html5:before{content:"\F13B"}.fa-css3:before{content:"\F13C"}.fa-anchor:before{content:"\F13D"}.fa-unlock-alt:before{content:"\F13E"}.fa-bullseye:before{content:"\F140"}.fa-ellipsis-h:before{content:"\F141"}.fa-ellipsis-v:before{content:"\F142"}.fa-rss-square:before{content:"\F143"}.fa-play-circle:before{content:"\F144"}.fa-ticket:before{content:"\F145"}.fa-minus-square:before{content:"\F146"}.fa-minus-square-o:before{content:"\F147"}.fa-level-up:before{content:"\F148"}.fa-level-down:before{content:"\F149"}.fa-check-square:before{content:"\F14A"}.fa-pencil-square:before{content:"\F14B"}.fa-external-link-square:before{content:"\F14C"}.fa-share-square:before{content:"\F14D"}.fa-compass:before{content:"\F14E"}.fa-caret-square-o-down:before,.fa-toggle-down:before{content:"\F150"}.fa-caret-square-o-up:before,.fa-toggle-up:before{content:"\F151"}.fa-caret-square-o-right:before,.fa-toggle-right:before{content:"\F152"}.fa-eur:before,.fa-euro:before{content:"\F153"}.fa-gbp:before{content:"\F154"}.fa-dollar:before,.fa-usd:before{content:"\F155"}.fa-inr:before,.fa-rupee:before{content:"\F156"}.fa-cny:before,.fa-jpy:before,.fa-rmb:before,.fa-yen:before{content:"\F157"}.fa-rouble:before,.fa-rub:before,.fa-ruble:before{content:"\F158"}.fa-krw:before,.fa-won:before{content:"\F159"}.fa-bitcoin:before,.fa-btc:before{content:"\F15A"}.fa-file:before{content:"\F15B"}.fa-file-text:before{content:"\F15C"}.fa-sort-alpha-asc:before{content:"\F15D"}.fa-sort-alpha-desc:before{content:"\F15E"}.fa-sort-amount-asc:before{content:"\F160"}.fa-sort-amount-desc:before{content:"\F161"}.fa-sort-numeric-asc:before{content:"\F162"}.fa-sort-numeric-desc:before{content:"\F163"}.fa-thumbs-up:before{content:"\F164"}.fa-thumbs-down:before{content:"\F165"}.fa-youtube-square:before{content:"\F166"}.fa-youtube:before{content:"\F167"}.fa-xing:before{content:"\F168"}.fa-xing-square:before{content:"\F169"}.fa-youtube-play:before{content:"\F16A"}.fa-dropbox:before{content:"\F16B"}.fa-stack-overflow:before{content:"\F16C"}.fa-instagram:before{content:"\F16D"}.fa-flickr:before{content:"\F16E"}.fa-adn:before{content:"\F170"}.fa-bitbucket:before{content:"\F171"}.fa-bitbucket-square:before{content:"\F172"}.fa-tumblr:before{content:"\F173"}.fa-tumblr-square:before{content:"\F174"}.fa-long-arrow-down:before{content:"\F175"}.fa-long-arrow-up:before{content:"\F176"}.fa-long-arrow-left:before{content:"\F177"}.fa-long-arrow-right:before{content:"\F178"}.fa-apple:before{content:"\F179"}.fa-windows:before{content:"\F17A"}.fa-android:before{content:"\F17B"}.fa-linux:before{content:"\F17C"}.fa-dribbble:before{content:"\F17D"}.fa-skype:before{content:"\F17E"}.fa-foursquare:before{content:"\F180"}.fa-trello:before{content:"\F181"}.fa-female:before{content:"\F182"}.fa-male:before{content:"\F183"}.fa-gittip:before,.fa-gratipay:before{content:"\F184"}.fa-sun-o:before{content:"\F185"}.fa-moon-o:before{content:"\F186"}.fa-archive:before{content:"\F187"}.fa-bug:before{content:"\F188"}.fa-vk:before{content:"\F189"}.fa-weibo:before{content:"\F18A"}.fa-renren:before{content:"\F18B"}.fa-pagelines:before{content:"\F18C"}.fa-stack-exchange:before{content:"\F18D"}.fa-arrow-circle-o-right:before{content:"\F18E"}.fa-arrow-circle-o-left:before{content:"\F190"}.fa-caret-square-o-left:before,.fa-toggle-left:before{content:"\F191"}.fa-dot-circle-o:before{content:"\F192"}.fa-wheelchair:before{content:"\F193"}.fa-vimeo-square:before{content:"\F194"}.fa-try:before,.fa-turkish-lira:before{content:"\F195"}.fa-plus-square-o:before{content:"\F196"}.fa-space-shuttle:before{content:"\F197"}.fa-slack:before{content:"\F198"}.fa-envelope-square:before{content:"\F199"}.fa-wordpress:before{content:"\F19A"}.fa-openid:before{content:"\F19B"}.fa-bank:before,.fa-institution:before,.fa-university:before{content:"\F19C"}.fa-graduation-cap:before,.fa-mortar-board:before{content:"\F19D"}.fa-yahoo:before{content:"\F19E"}.fa-google:before{content:"\F1A0"}.fa-reddit:before{content:"\F1A1"}.fa-reddit-square:before{content:"\F1A2"}.fa-stumbleupon-circle:before{content:"\F1A3"}.fa-stumbleupon:before{content:"\F1A4"}.fa-delicious:before{content:"\F1A5"}.fa-digg:before{content:"\F1A6"}.fa-pied-piper:before{content:"\F1A7"}.fa-pied-piper-alt:before{content:"\F1A8"}.fa-drupal:before{content:"\F1A9"}.fa-joomla:before{content:"\F1AA"}.fa-language:before{content:"\F1AB"}.fa-fax:before{content:"\F1AC"}.fa-building:before{content:"\F1AD"}.fa-child:before{content:"\F1AE"}.fa-paw:before{content:"\F1B0"}.fa-spoon:before{content:"\F1B1"}.fa-cube:before{content:"\F1B2"}.fa-cubes:before{content:"\F1B3"}.fa-behance:before{content:"\F1B4"}.fa-behance-square:before{content:"\F1B5"}.fa-steam:before{content:"\F1B6"}.fa-steam-square:before{content:"\F1B7"}.fa-recycle:before{content:"\F1B8"}.fa-automobile:before,.fa-car:before{content:"\F1B9"}.fa-cab:before,.fa-taxi:before{content:"\F1BA"}.fa-tree:before{content:"\F1BB"}.fa-spotify:before{content:"\F1BC"}.fa-deviantart:before{content:"\F1BD"}.fa-soundcloud:before{content:"\F1BE"}.fa-database:before{content:"\F1C0"}.fa-file-pdf-o:before{content:"\F1C1"}.fa-file-word-o:before{content:"\F1C2"}.fa-file-excel-o:before{content:"\F1C3"}.fa-file-powerpoint-o:before{content:"\F1C4"}.fa-file-image-o:before,.fa-file-photo-o:before,.fa-file-picture-o:before{content:"\F1C5"}.fa-file-archive-o:before,.fa-file-zip-o:before{content:"\F1C6"}.fa-file-audio-o:before,.fa-file-sound-o:before{content:"\F1C7"}.fa-file-movie-o:before,.fa-file-video-o:before{content:"\F1C8"}.fa-file-code-o:before{content:"\F1C9"}.fa-vine:before{content:"\F1CA"}.fa-codepen:before{content:"\F1CB"}.fa-jsfiddle:before{content:"\F1CC"}.fa-life-bouy:before,.fa-life-buoy:before,.fa-life-ring:before,.fa-life-saver:before,.fa-support:before{content:"\F1CD"}.fa-circle-o-notch:before{content:"\F1CE"}.fa-ra:before,.fa-rebel:before{content:"\F1D0"}.fa-empire:before,.fa-ge:before{content:"\F1D1"}.fa-git-square:before{content:"\F1D2"}.fa-git:before{content:"\F1D3"}.fa-hacker-news:before,.fa-y-combinator-square:before,.fa-yc-square:before{content:"\F1D4"}.fa-tencent-weibo:before{content:"\F1D5"}.fa-qq:before{content:"\F1D6"}.fa-wechat:before,.fa-weixin:before{content:"\F1D7"}.fa-paper-plane:before,.fa-send:before{content:"\F1D8"}.fa-paper-plane-o:before,.fa-send-o:before{content:"\F1D9"}.fa-history:before{content:"\F1DA"}.fa-circle-thin:before{content:"\F1DB"}.fa-header:before{content:"\F1DC"}.fa-paragraph:before{content:"\F1DD"}.fa-sliders:before{content:"\F1DE"}.fa-share-alt:before{content:"\F1E0"}.fa-share-alt-square:before{content:"\F1E1"}.fa-bomb:before{content:"\F1E2"}.fa-futbol-o:before,.fa-soccer-ball-o:before{content:"\F1E3"}.fa-tty:before{content:"\F1E4"}.fa-binoculars:before{content:"\F1E5"}.fa-plug:before{content:"\F1E6"}.fa-slideshare:before{content:"\F1E7"}.fa-twitch:before{content:"\F1E8"}.fa-yelp:before{content:"\F1E9"}.fa-newspaper-o:before{content:"\F1EA"}.fa-wifi:before{content:"\F1EB"}.fa-calculator:before{content:"\F1EC"}.fa-paypal:before{content:"\F1ED"}.fa-google-wallet:before{content:"\F1EE"}.fa-cc-visa:before{content:"\F1F0"}.fa-cc-mastercard:before{content:"\F1F1"}.fa-cc-discover:before{content:"\F1F2"}.fa-cc-amex:before{content:"\F1F3"}.fa-cc-paypal:before{content:"\F1F4"}.fa-cc-stripe:before{content:"\F1F5"}.fa-bell-slash:before{content:"\F1F6"}.fa-bell-slash-o:before{content:"\F1F7"}.fa-trash:before{content:"\F1F8"}.fa-copyright:before{content:"\F1F9"}.fa-at:before{content:"\F1FA"}.fa-eyedropper:before{content:"\F1FB"}.fa-paint-brush:before{content:"\F1FC"}.fa-birthday-cake:before{content:"\F1FD"}.fa-area-chart:before{content:"\F1FE"}.fa-pie-chart:before{content:"\F200"}.fa-line-chart:before{content:"\F201"}.fa-lastfm:before{content:"\F202"}.fa-lastfm-square:before{content:"\F203"}.fa-toggle-off:before{content:"\F204"}.fa-toggle-on:before{content:"\F205"}.fa-bicycle:before{content:"\F206"}.fa-bus:before{content:"\F207"}.fa-ioxhost:before{content:"\F208"}.fa-angellist:before{content:"\F209"}.fa-cc:before{content:"\F20A"}.fa-ils:before,.fa-shekel:before,.fa-sheqel:before{content:"\F20B"}.fa-meanpath:before{content:"\F20C"}.fa-buysellads:before{content:"\F20D"}.fa-connectdevelop:before{content:"\F20E"}.fa-dashcube:before{content:"\F210"}.fa-forumbee:before{content:"\F211"}.fa-leanpub:before{content:"\F212"}.fa-sellsy:before{content:"\F213"}.fa-shirtsinbulk:before{content:"\F214"}.fa-simplybuilt:before{content:"\F215"}.fa-skyatlas:before{content:"\F216"}.fa-cart-plus:before{content:"\F217"}.fa-cart-arrow-down:before{content:"\F218"}.fa-diamond:before{content:"\F219"}.fa-ship:before{content:"\F21A"}.fa-user-secret:before{content:"\F21B"}.fa-motorcycle:before{content:"\F21C"}.fa-street-view:before{content:"\F21D"}.fa-heartbeat:before{content:"\F21E"}.fa-venus:before{content:"\F221"}.fa-mars:before{content:"\F222"}.fa-mercury:before{content:"\F223"}.fa-intersex:before,.fa-transgender:before{content:"\F224"}.fa-transgender-alt:before{content:"\F225"}.fa-venus-double:before{content:"\F226"}.fa-mars-double:before{content:"\F227"}.fa-venus-mars:before{content:"\F228"}.fa-mars-stroke:before{content:"\F229"}.fa-mars-stroke-v:before{content:"\F22A"}.fa-mars-stroke-h:before{content:"\F22B"}.fa-neuter:before{content:"\F22C"}.fa-genderless:before{content:"\F22D"}.fa-facebook-official:before{content:"\F230"}.fa-pinterest-p:before{content:"\F231"}.fa-whatsapp:before{content:"\F232"}.fa-server:before{content:"\F233"}.fa-user-plus:before{content:"\F234"}.fa-user-times:before{content:"\F235"}.fa-bed:before,.fa-hotel:before{content:"\F236"}.fa-viacoin:before{content:"\F237"}.fa-train:before{content:"\F238"}.fa-subway:before{content:"\F239"}.fa-medium:before{content:"\F23A"}.fa-y-combinator:before,.fa-yc:before{content:"\F23B"}.fa-optin-monster:before{content:"\F23C"}.fa-opencart:before{content:"\F23D"}.fa-expeditedssl:before{content:"\F23E"}.fa-battery-4:before,.fa-battery-full:before{content:"\F240"}.fa-battery-3:before,.fa-battery-three-quarters:before{content:"\F241"}.fa-battery-2:before,.fa-battery-half:before{content:"\F242"}.fa-battery-1:before,.fa-battery-quarter:before{content:"\F243"}.fa-battery-0:before,.fa-battery-empty:before{content:"\F244"}.fa-mouse-pointer:before{content:"\F245"}.fa-i-cursor:before{content:"\F246"}.fa-object-group:before{content:"\F247"}.fa-object-ungroup:before{content:"\F248"}.fa-sticky-note:before{content:"\F249"}.fa-sticky-note-o:before{content:"\F24A"}.fa-cc-jcb:before{content:"\F24B"}.fa-cc-diners-club:before{content:"\F24C"}.fa-clone:before{content:"\F24D"}.fa-balance-scale:before{content:"\F24E"}.fa-hourglass-o:before{content:"\F250"}.fa-hourglass-1:before,.fa-hourglass-start:before{content:"\F251"}.fa-hourglass-2:before,.fa-hourglass-half:before{content:"\F252"}.fa-hourglass-3:before,.fa-hourglass-end:before{content:"\F253"}.fa-hourglass:before{content:"\F254"}.fa-hand-grab-o:before,.fa-hand-rock-o:before{content:"\F255"}.fa-hand-paper-o:before,.fa-hand-stop-o:before{content:"\F256"}.fa-hand-scissors-o:before{content:"\F257"}.fa-hand-lizard-o:before{content:"\F258"}.fa-hand-spock-o:before{content:"\F259"}.fa-hand-pointer-o:before{content:"\F25A"}.fa-hand-peace-o:before{content:"\F25B"}.fa-trademark:before{content:"\F25C"}.fa-registered:before{content:"\F25D"}.fa-creative-commons:before{content:"\F25E"}.fa-gg:before{content:"\F260"}.fa-gg-circle:before{content:"\F261"}.fa-tripadvisor:before{content:"\F262"}.fa-odnoklassniki:before{content:"\F263"}.fa-odnoklassniki-square:before{content:"\F264"}.fa-get-pocket:before{content:"\F265"}.fa-wikipedia-w:before{content:"\F266"}.fa-safari:before{content:"\F267"}.fa-chrome:before{content:"\F268"}.fa-firefox:before{content:"\F269"}.fa-opera:before{content:"\F26A"}.fa-internet-explorer:before{content:"\F26B"}.fa-television:before,.fa-tv:before{content:"\F26C"}.fa-contao:before{content:"\F26D"}.fa-500px:before{content:"\F26E"}.fa-amazon:before{content:"\F270"}.fa-calendar-plus-o:before{content:"\F271"}.fa-calendar-minus-o:before{content:"\F272"}.fa-calendar-times-o:before{content:"\F273"}.fa-calendar-check-o:before{content:"\F274"}.fa-industry:before{content:"\F275"}.fa-map-pin:before{content:"\F276"}.fa-map-signs:before{content:"\F277"}.fa-map-o:before{content:"\F278"}.fa-map:before{content:"\F279"}.fa-commenting:before{content:"\F27A"}.fa-commenting-o:before{content:"\F27B"}.fa-houzz:before{content:"\F27C"}.fa-vimeo:before{content:"\F27D"}.fa-black-tie:before{content:"\F27E"}.fa-fonticons:before{content:"\F280"}.fa-reddit-alien:before{content:"\F281"}.fa-edge:before{content:"\F282"}.fa-credit-card-alt:before{content:"\F283"}.fa-codiepie:before{content:"\F284"}.fa-modx:before{content:"\F285"}.fa-fort-awesome:before{content:"\F286"}.fa-usb:before{content:"\F287"}.fa-product-hunt:before{content:"\F288"}.fa-mixcloud:before{content:"\F289"}.fa-scribd:before{content:"\F28A"}.fa-pause-circle:before{content:"\F28B"}.fa-pause-circle-o:before{content:"\F28C"}.fa-stop-circle:before{content:"\F28D"}.fa-stop-circle-o:before{content:"\F28E"}.fa-shopping-bag:before{content:"\F290"}.fa-shopping-basket:before{content:"\F291"}.fa-hashtag:before{content:"\F292"}.fa-bluetooth:before{content:"\F293"}.fa-bluetooth-b:before{content:"\F294"}.fa-percent:before{content:"\F295"}.sidebar{width:calc(99.9% * 1/3 - 20px)}.sidebar:nth-child(1n){float:left;margin-right:30px;clear:none}.sidebar:last-child{margin-right:0}.sidebar:nth-child(3n){margin-right:0;float:right}.sidebar:nth-child(3n+1){clear:both}.sidebar .sidebar-inner{position:relative;padding:40px}.sidebar .sidebar-inner:after{background:#eee;background:-webkit-linear-gradient(top,#eee,#eee 48%,#fff);background:linear-gradient(180deg,#eee 0,#eee 48%,#fff);position:absolute;content:'';width:1px;height:540px;top:30px;right:-10px;bottom:0}.sidebar .sidebar-inner img{display:inline-block;margin-bottom:0;border-radius:5%;background-clip:padding-box}.sidebar .sidebar-inner h1,.sidebar .sidebar-inner h2{font-size:18px;font-weight:500;line-height:18px;margin:20px 0 10px}.sidebar .sidebar-inner p{color:#888;font-size:16px;line-height:26px;margin-bottom:26px}.sidebar .sidebar-inner p.copyright{color:#b6b6b6;font-size:14px}@media (max-width:1100px){.sidebar .sidebar-inner{padding:35px 20px 0}.sidebar{width:calc(99.9% * 1/2 - 15px)}.sidebar:nth-child(1n){float:left;margin-right:30px;clear:none}.sidebar:last-child{margin-right:0}.sidebar:nth-child(2n){margin-right:0;float:right}.sidebar:nth-child(2n+1){clear:both}}@media (max-width:900px){.sidebar{width:calc(99.9% * 5/12 - 17.5px)}.sidebar:nth-child(1n){float:left;margin-right:30px;clear:none}.sidebar:last-child{margin-right:0}.sidebar:nth-child(12n){margin-right:0;float:right}.sidebar:nth-child(12n+1){clear:both}.sidebar .sidebar-inner{padding:30px 20px 0}}@media (max-width:500px){.sidebar{width:calc(99.9% * 1 - 0px)}.sidebar:nth-child(1n){float:left;margin-right:30px;clear:none}.sidebar:last-child{margin-right:0}.sidebar:nth-child(undefinedn){margin-right:0;float:right}.sidebar:nth-child(undefinedn+1){clear:both}.sidebar .sidebar-inner{padding:25px 20px 0}.sidebar .sidebar-inner:after{display:none}}.blog-page{margin-bottom:40px}.blog-page h1{font-size:calc(20px + 16 * ((100vw - 420px) / 860));margin-top:0}@media screen and (min-width:1280px){.blog-page h1{font-size:36px}}@media screen and (max-width:420px){.blog-page h1{font-size:20px}}.blog-page p{font-size:16px;line-height:26px;margin-bottom:26px}.blog-page a{text-decoration:underline}@media (max-width:900px){.blog-single .footer,.blog-single .text{padding:0 15px}}</style></head><body><div id="react-mount"><div class="wrapper" data-reactroot="" data-reactid="1" data-react-checksum="-628567113"><div data-reactid="2"><div data-reactid="3"><div data-reactid="4"><a class="gohome" href="/blog/" data-reactid="5"> All Articles</a></div><div class="blog-single" data-reactid="6"><div class="text" data-reactid="7"><h1 data-reactid="8">Writing a &#x27;trampoline&#x27; in assembly for profiling</h1><div class="date-published" data-reactid="9"><em data-reactid="10">7 Dec 2015</em></div><div data-reactid="11"><h2>Context</h2>
<p><a href="http://facebook.github.io/react-native">React Native</a> has different characteristics than “regular” iOS and JavaScript development, understanding the flow of events across the stack, even working on it, can be complicate sometimes. In order to make easier, I’ve been working on a custom profiler for React Native, inspired by <a href="http://developer.android.com/tools/help/systrace.html">Android systrace</a> and using the same front-end, <a href="https://github.com/catapult-project/catapult/tree/master/tracing">Google trace-viewer</a>.</p>
<p><img src="trampoline_systrace.png" alt="Sample systrace output"></p>
<h2>Goal</h2>
<p>My initial goal was to visualise at least what was happening in the <a href="http://facebook.github.io/react-native/docs/native-modules-ios.html#content">Native Modules</a>, so I started manually adding markers to the critical parts of the framework, like the <a href="https://github.com/facebook/react-native/blob/master/React/Base/RCTBatchedBridge.m">Bridge</a> and the <a href="https://github.com/facebook/react-native/blob/master/React/Modules/RCTUIManager.m">UIManager</a>, but what I really wanted was to have markers in every method of every native module, and manually adding markers is not only inefficient, but impossible when it comes to third-party code. Doing it dynamically also has the benefit of having zero overhead when the profiler is not running - the code paths don’t even exist unless you activate the profiler.</p>
<p>Since all the modules are registered with the bridge, and Objective-C is very dynamic, we can simply add markers to all the module’s methods at runtime, so the actual goal here is to execute something before the method body - mark the start of the method, and after the method body - mark the end of the method.</p>
<pre><code class="language-objc">- (<span class="hljs-keyword">void</span>)myMethod {
  profilerBegin(<span class="hljs-string">@"myMethod"</span>); <span class="hljs-comment">// We need to execute this prologue</span>

  <span class="hljs-comment">// method body</span>

  profilerEnd(<span class="hljs-string">@"myMethod"</span>); <span class="hljs-comment">// and this epilogue</span>
}
</code></pre>
<p>Objective-C has everything we need to introspect the classes, find the methods, and replace them, <em>but…</em> what do we replace them with? How do you still call the original method with a variable number of arguments?</p>
<h1>NSInvocation</h1>
<p>So my initial approach¹ was inspired by Peter Steinberger’s <a href="https://github.com/steipete/Aspects">Aspects</a> library, but much less flexible, since I only needed a very specific prologue and epilogue.</p>
<p>The basic idea behind the implementation was allocating a new <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/#//apple_ref/c/func/objc_allocateClassPair">class pair</a>, and for every method in the class, we’d first rename it by adding a prefix, and add it (without the prefix) to the new class. The new class’ implementation however was only <a href="http://www.opensource.apple.com/source/objc4/objc4-532.2/runtime/message.h">_objc_msgForward</a>, which <em>forwards</em> the message, we then implement the <code>forwardInvocation:</code>² method, which takes a <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSInvocation_Class/">NSInvocation</a> instance ready, with the object with are calling, the selector and all the arguments. Done!</p>
<p>All we need to do now in <code>-forwardInvocation:</code> is:</p>
<ul>
<li>prepend the prefix we used when renaming the method to selector,</li>
<li>start the profiler,</li>
<li>invoke the <code>NSInvocation</code>,</li>
<li>stop the profiler,</li>
<li>return the invocation result.</li>
</ul>
<p><img src="forward_invocation_scheme.png" alt="forward invocation scheme"></p>
<p><small>1. the original implementation can still be found <a href="https://github.com/facebook/react-native/blob/1b296904962709d06381523f39ccdffae775dd44/React/Base/RCTProfile.m#L183">here</a></small>
<small>2. see the Apple’s <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtForwarding.html">Message Forwarding</a> guide for more information</small></p>
<h1>Assembly version</h1>
<p>Everything was already working, why bother to implement it in assembly? Well, <code>NSInvocation</code> is slow (here are some <a href="https://geekanddad.wordpress.com/2013/03/14/1636/">benchmarks</a> to have an idea), usually it’s alright out of critical paths, but wrapping every method in it, for profiling reasons, is not great.</p>
<p>Plus, it’s a <strong>much</strong> easier problem to solve in assembly!</p>
<p>Let’s look at a basic example: you have a function <code>A</code>, that’s only a proxy for <code>void B(void)</code>, how do you solve it in C?</p>
<pre><code class="language-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">A</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{ B(); }
</code></pre>
<p>That’s easy, but what if <code>A</code> now has to proxy to both, <code>B</code> and <code>add</code>, but <code>B</code> returns <code>void</code> and takes no arguments, and <code>add</code> takes two <code>int</code>s and returns the sum as one <code>int</code>. It’s not possible. The language semantics don’t support it, you’d have to convert both functions to take <code>va_args</code>, but if you fall back to assembly, it’s as simple as:</p>
<pre><code class="language-x86asm"><span class="hljs-symbol">A:</span>
<span class="hljs-comment">; some logic to decide between jmp_B and jmp_add</span>
<span class="hljs-symbol">
jmp_B:</span>
  <span class="hljs-keyword">jmp</span> B
<span class="hljs-symbol">jmp_add:</span>
  <span class="hljs-keyword">jmp</span> <span class="hljs-keyword">add</span>
</code></pre>
<p>All the arguments are in the right registers, or in the right position in the stack, all we have to do is execute the target method - just <code>jmp</code> to it.</p>
<p>These functions, that basically only redirect to another function, like <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/#//apple_ref/c/func/objc_msgSend">objc_msgSend</a>, are sometimes called <em>trampolines</em>. In fact the x86_64 implementation I’m going to present is heavily inspired in the <a href="https://github.com/opensource-apple/objc4/blob/17d47b3989923007fa052f346b05a32fca389465/runtime/Messengers.subproj/objc-msg-x86_64.s#L289">original objc_msgSend implementation</a> and Mike Ash’s post <a href="https://www.mikeash.com/pyblog/friday-qa-2012-11-16-lets-build-objc_msgsend.html">“Let’s Build objc_msgSend”</a>, the main difference is that <code>objc_msgSend</code> calls the underlying function and returns directly to it’s caller, i.e. there’s no epilogue.</p>
<h1>x86_64 - calling conventions</h1>
<p>In order to do anything properly in assembly, we first need to understand the <a href="http://people.freebsd.org/~obrien/amd64-elf-abi.pdf">calling conventions</a>, you can look at the <code>Register Usage</code> in Figure 3.4, but I’ll add here only the bits we need:</p>
<ul>
<li>Callee-saved registers: these registers’ values will be preserved across function calls (which also means that we have to restore its value before returning)
<ul>
<li>I’ll just be using <code>%r12</code>, <code>%r13</code> and <code>%r14</code> - check the <a href="http://people.freebsd.org/~obrien/amd64-elf-abi.pdf">calling conventions</a> for the full list.</li>
</ul>
</li>
<li>Argument registers:
<ul>
<li><code>%rdi</code>, <code>%rsi</code>, <code>%rdx</code>, <code>%rcx</code>, <code>%r8</code> and <code>%r9</code> hold the first 6 quad-word arguments (pointers and integers).</li>
<li><code>%xmm0</code> to <code>%xmm7</code> are used to pass floating point arguments</li>
<li><code>%rax</code> is used in variable-argument calls to store the number of SSE registers</li>
</ul>
</li>
</ul>
<p>It’s also important to understand the stack layout. All the arguments that don’t fit in the registers will be put in the stack. Plus, when you call a method, using the <code>call</code> instruction, it’ll push the return address onto the stack, so when the called function calls <code>ret</code>, it knows the right address to return.</p>
<h1>Designing the trampoline</h1>
<p>High-level design:</p>
<ul>
<li>Store all the argument registers</li>
<li>Determine the address of the “actual function”</li>
<li>Start profiling</li>
<li>Restore the argument registers</li>
<li>Call the “actual function”</li>
<li>Save the returned values</li>
<li>Stop profiling</li>
<li>Restore the returned values</li>
<li>Return to the caller</li>
</ul>
<p>Simple, right? Yes, but if you’ve been paying close attention you might have noticed that at the point that we call the “actual function” we have to restore all the registers <em>and</em> all the stack state, e.g. everything has to look exactly the same as it did at the beginning of the function, <em>except</em> the return address, since we want the “actual function” to return to the trampoline rather than to its caller.</p>
<p>The catch is that when we replace the return address with ours instead of the caller we have nowhere to store the original return address (so we can return to it at the end): we can’t store it in the stack, because it can’t contain any extra values; we can’t store it in temporary registers, because their value is not guaranteed to be preserved across the function call; we could store it in callee-saved registers, but we’d need to restore the register’s original value at the end of the function, and then we’d have the same problem to store it…</p>
<p>Which bring us to the heap, we can allocate a small block of memory, so we can save the return address! But where do we save the block of memory’s address? The idea here is to allocate the size of two registers: we store the original value of two callee-saved registers there, and then we use the callee-saved registers (<code>%r14</code> and <code>%r13</code> in this case) to store the block of memory’s address and the original return address, respectively.</p>
<p>So our design now looks a bit more like:</p>
<ul>
<li>Store all the argument registers</li>
<li>Determine the address of the “actual function”</li>
<li>Allocate a 16-bytes in the heap</li>
<li>Save two callee-saved registers in the heap memory</li>
<li>Save the memory address in callee-saved register #1</li>
<li>Start profiling</li>
<li>Restore the argument registers</li>
<li>Pop the original return address from the stack into callee-save register #2</li>
<li>Call the “actual function” (this will push our return address onto the stack)</li>
<li>Save the returned values</li>
<li>Stop profiling</li>
<li>Restore the callee-saved registers and free the allocated memory</li>
<li>Restore the returned values</li>
<li>Return to the caller</li>
</ul>
<h2>Storing all the argument registers</h2>
<p>First thing we need to do is to store all the argument registers, this way we can be sure we won’t miss any parameters when we call the “actual function” after the prologue execution.</p>
<p>Once you know which registers need to be stored, this is the simplest part, all you need to do is save everything in the stack.</p>
<p>For the word-size registers, all we need to do is <code>push</code> (the <code>q</code> suffix is just to make it explicit that it’s a quad-word instruction, i.e. 8-bytes):</p>
<pre><code class="language-x86asm">pushq %rdi
pushq %rsi
pushq %rdx
pushq %rcx
pushq %r8
pushq %r9
pushq %rax
</code></pre>
<p>Now the <code>%xmm</code> registers: they hold the floating point arguments, and they can’t be simply <code>push</code>ed. We have to subtract the size we need from the stack (each register is 16-bytes) and move them using the <code>movdqa</code><sup>1</sup> command:</p>
<pre><code class="language-x86asm">subq <span class="hljs-number">$0</span>x80+<span class="hljs-number">8</span>, %rsp <span class="hljs-comment">; 8 x 16-bytes xmm registers + 8-bytes alignment for example</span>
<span class="hljs-keyword">movdqa</span>  %xmm0, <span class="hljs-number">0x70</span>(%rsp)
<span class="hljs-keyword">movdqa</span>  %xmm1, <span class="hljs-number">0x60</span>(%rsp)
<span class="hljs-keyword">movdqa</span>  %xmm2, <span class="hljs-number">0x50</span>(%rsp)
<span class="hljs-keyword">movdqa</span>  %xmm3, <span class="hljs-number">0x40</span>(%rsp)
<span class="hljs-keyword">movdqa</span>  %xmm4, <span class="hljs-number">0x30</span>(%rsp)
<span class="hljs-keyword">movdqa</span>  %xmm5, <span class="hljs-number">0x20</span>(%rsp)
<span class="hljs-keyword">movdqa</span>  %xmm6, <span class="hljs-number">0x10</span>(%rsp)
<span class="hljs-keyword">movdqa</span>  %xmm7, <span class="hljs-number">0x00</span>(%rsp)
</code></pre>
<p><small><sup>1</sup> <code>movdqa</code> stands for “move double quad-word aligned” - which means that this instruction expects the stack to be 16-byte aligned (i.e. the stack pointer’s value, <code>%rsp</code>, has to be a multiple of <code>16</code>), otherwise it’ll crash.</small></p>
<h2>Getting the “actual function” address</h2>
<p>Based on the arguments used to call the trampoline we now have to find the address of the original implementation, which we’ve referred to as the “actual function”. There are a couple assumptions that make it easier:</p>
<ul>
<li>Since we are only profiling Objective-C methods, we’ll always receive the target object, <code>self</code>, and the selector, <code>_cmd</code>, as the first two parameters</li>
<li>As part of the proxy class creation we implement the <code>-class</code> method such that it returns the original class instead of the proxy one</li>
</ul>
<p>This way we can get the original class from the object, and it’ll contain the original method implementation. This is actually implemented as a one line C function:</p>
<pre><code class="language-c"><span class="hljs-function">IMP <span class="hljs-title">RCTProfileGetImplementation</span><span class="hljs-params">(id obj, SEL cmd)</span> </span>{
  <span class="hljs-keyword">return</span> class_getMethodImplementation([obj <span class="hljs-keyword">class</span>], cmd);
}
</code></pre>
<p>We also know that these were the same first two arguments passed to the trampoline, so we don’t even need mess with the parameter registers, we can just call it straight after saving the registers:</p>
<pre><code class="language-x86asm"><span class="hljs-keyword">call</span> _RCTProfileGetImplementation
</code></pre>
<h2>Save registers in the heap</h2>
<p>At the moment we call the “actual function” we won’t be able to keep state neither in registers nor in the stack, so we allocate a small memory block in the heap to keep the information that has to be preserved across the call.</p>
<p>Allocating memory in the heap is as easy as calling <code>malloc</code>, then we just <code>mov</code> the registers to the memory and <code>mov</code> the memory address to the callee-saved registers, so we can access it later.</p>
<pre><code class="language-x86asm"><span class="hljs-keyword">movq</span> <span class="hljs-number">$0</span>x10, %rdi <span class="hljs-comment">; put 16 on the first parameter register, to allocate 16 bytes</span>
callq _malloc <span class="hljs-comment">; call malloc(16), the address will be returned in %rax</span>

<span class="hljs-keyword">mov</span> %r13, (%rax) <span class="hljs-comment">; save callee-saved register %r13 in the first 8-bytes</span>
<span class="hljs-keyword">mov</span> %r14, <span class="hljs-number">0x8</span>(%rax) <span class="hljs-comment">; save callee-saved register %r14 in the second 8-bytes</span>

<span class="hljs-keyword">mov</span> %rax, %r14 <span class="hljs-comment">; save the memory address in the callee-saved register</span>
</code></pre>
<h2>Start profiling</h2>
<p>Now we just need to start the timer before calling the “actual function”, the function that actually starts the profiler is another one line C function:</p>
<pre><code class="language-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RCTProfileTrampolineStart</span><span class="hljs-params">(id obj, SEL cmd)</span> </span>{
  RCT_PROFILE_BEGIN_EVENT(<span class="hljs-number">0</span>, [NSString stringWithFormat:@<span class="hljs-string">"-[%s %s]"</span>, class_getName([obj <span class="hljs-keyword">class</span>]), sel_getName(cmd)], nil);
}
</code></pre>
<p>It takes the same two arguments as <code>RCTProfileGetImplementation</code> (used to identify the method), and call the macro that actually starts measuring.</p>
<p>However, in this case the arguments that we need to pass to function are not in the right registers anymore, so we have to retrieve it from the stack (the sample code is using the offsets that are currently being used in the actual source):</p>
<pre><code class="language-x86asm"><span class="hljs-keyword">movq</span> <span class="hljs-number">0x40</span>(%r12), %rdi <span class="hljs-comment">; object - type `id` (pointer) in the 1st argument register</span>
<span class="hljs-keyword">movq</span> <span class="hljs-number">0x38</span>(%r12), %rsi <span class="hljs-comment">; selector - type `SEL` (pointer) in the 2nd argument register</span>

callq _RCTProfileTrampolineStart
</code></pre>
<h2>Restore the state</h2>
<p>Before we call the “actual function” we have to make sure we put all the arguments that were passed to the trampoline back in the right registers, so we pass all the parameters along. We also need to remove anything we saved on the stack, such that the stack pointer has the same value it had at the begin of the function.</p>
<p>This part is very similar to storing the arguments, except that we have to <code>pop</code> from the stack instead of <code>push</code>ing, and call <code>movdqa</code> with the parameters switched, so that we move it <em>from</em> the stack to the registers. I won’t add the code here because it’s not only very similar, but also very repetitive. Also, the whole code will be available at the end.</p>
<h2>Pop the original return address + call the “actual function”</h2>
<p>Now that all the registers and the stack are in the exact same state as they were at the moment that the trampoline was called, and the profiler is already running, we can safely call the “actual function” we want to measure.</p>
<p>Before that, we must have stored the &quot;actual function&quot;s address in the stack, and as part of restoring the state we must have poped the &quot;actual function&quot;s address from the stack into some register. The original implementation stored it in the temporary register <code>%r11</code>, so I’ll assume it here:</p>
<pre><code class="language-x86asm">popq %r13 <span class="hljs-comment">; save the original memory address</span>
callq *%r11 <span class="hljs-comment">; call the original function - this will automatically push the new return address</span>
</code></pre>
<h2>Save the returned values</h2>
<p>Now that we have called the “actual function” we have to preserve all the registers that might possibly contain a return value (or part of it).</p>
<p>We’ll push onto the stack the value-return registers, i.e. <code>%rax</code> and <code>%rdx</code> for the 8-bytes values and <code>%xmm0</code> and <code>%xmm1</code> for floating point return values:</p>
<pre><code class="language-x86asm">pushq %rax <span class="hljs-comment">; 1st return register</span>
pushq %rdx <span class="hljs-comment">; 2nd return register</span>
subq <span class="hljs-number">$0</span>x20, %rsp <span class="hljs-comment">; allocate the space for 2 16-bytes xmm register</span>
<span class="hljs-keyword">movdqa</span> %xmm0, <span class="hljs-number">0x00</span>(%rsp) <span class="hljs-comment">; 1st floating point return register</span>
<span class="hljs-keyword">movdqa</span> %xmm1, <span class="hljs-number">0x10</span>(%rsp) <span class="hljs-comment">; 2nd floating point return register</span>
</code></pre>
<h2>Stop profiling</h2>
<p>We already executed everything that should be measured, and the return values are safe, so now we can stop measuring.</p>
<p>Again, the stop profiling function is implemented in C and all it does is calling a macro:</p>
<pre><code class="language-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RCTProfileTrampolineEnd</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  RCT_PROFILE_END_EVENT(<span class="hljs-number">0</span>, @<span class="hljs-string">"objc_call,modules,auto"</span>, nil);
}
</code></pre>
<p>And we only need to <code>call</code> it, since it doesn’t expect any arguments:</p>
<pre><code class="language-x86asm">callq _RCTProfileTrampolineEnd
</code></pre>
<h2>Restore the callee-saved registers and free the allocated memory</h2>
<p>As explained above, the callee-saved registers are the ones whose value is preserved when you call a function, which also implies that at the end of our functions, if we have modified them, we must restore their original values.</p>
<p>We have to make sure to save the value currently stored in the callee-saved register <code>%r13</code> before we restore it. This register holds our caller’s address, to where we need to jump once we are done.</p>
<p>Finally, after we restore the registers’ original values, we can <code>free</code> the memory.</p>
<pre><code class="language-x86asm">pushq %r13 <span class="hljs-comment">; save the caller's address in the stack</span>
<span class="hljs-keyword">movq</span> %r14, %rdi <span class="hljs-comment">; move the heap's address to %rdi</span>

<span class="hljs-comment">; restore the callee-saved registers</span>
<span class="hljs-keyword">movq</span> <span class="hljs-number">0x0</span>(%r14), %r13
<span class="hljs-keyword">movq</span> <span class="hljs-number">0x8</span>(%r14), %r14

callq _free <span class="hljs-comment">; call free, since the address has already been placed in %rdi</span>
</code></pre>
<h2>Restore the returned values and return to the caller</h2>
<p>All the work is done, we just have to restore the return registers so they have the same value as after the “actual function” returned. This is the same as returning any value that the “actual function” might have possibly returned.</p>
<pre><code class="language-x86asm">popq %rcx <span class="hljs-comment">; pop the return address into a temporary register</span>
<span class="hljs-keyword">movdqa</span> <span class="hljs-number">0x00</span>(%rsp), %xmm0 <span class="hljs-comment">; 1st floating point return register</span>
<span class="hljs-keyword">movdqa</span> <span class="hljs-number">0x10</span>(%rsp), %xmm1 <span class="hljs-comment">; 2nd floating point return register</span>
addq <span class="hljs-number">$0</span>x20, %rsp <span class="hljs-comment">; return the size used for the two registers above</span>
popq %rdx <span class="hljs-comment">; 2nd return register</span>
popq %rax <span class="hljs-comment">; 1st return register</span>
</code></pre>
<p>Last but not least, we <code>jmp</code> to our caller’s next instruction, so it keeps going on executing:</p>
<pre><code class="language-x86asm"><span class="hljs-comment">; jump to caller</span>
jmpq *%rcx
</code></pre>
<h1>Notes</h1>
<ul>
<li>The full code, currently being used in React Native, can be found in the <a href="https://github.com/facebook/react-native/blob/master/React/Profiler/RCTProfileTrampoline-x86_64.S">GitHub repo</a> and has lots of comments.</li>
<li>The snippets here don’t deal with memory alignment: the stack has to be 16-byte aligned before calling a function or operating on xmm and sse registers.</li>
<li>The snippets also don’t match 1:1 with the current code, in some points I tried to make it simpler, in others I just thought it could be improved and will update the source code later.</li>
<li>The repo also contains the <code>i386</code>, <code>armv7</code> and <code>arm64</code> versions, have fun.</li>
</ul>
<p><em>Assembly is fun! :D</em></p>
<hr>
<h1>External links</h1>
<ul>
<li><a href="http://facebook.github.io/react-native">React Native</a></li>
<li><a href="http://developer.android.com/tools/help/systrace.html">Android Systrace</a></li>
<li><a href="https://github.com/catapult-project/catapult/tree/master/tracing">Google trace-viewer</a></li>
<li><a href="http://facebook.github.io/react-native/docs/native-modules-ios.html#content">React Native’s “Native Modules”</a></li>
<li><a href="https://github.com/facebook/react-native/blob/master/React/Base/RCTBatchedBridge.m">React Native’s “Bridge”</a></li>
<li><a href="https://github.com/facebook/react-native/blob/master/React/Modules/RCTUIManager.m">React Native’s “UIManager”</a></li>
<li><a href="https://github.com/steipete/Aspects">Aspects by Peter Steinberger</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/#//apple_ref/c/func/objc_allocateClassPair">objc_allocateClassPair docs</a></li>
<li><a href="http://www.opensource.apple.com/source/objc4/objc4-532.2/runtime/message.h">_objc_msgForward’s header file</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtForwarding.html">Message Forwarding docs</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSInvocation_Class/">NSInvocation class reference</a></li>
<li><a href="https://github.com/facebook/react-native/blob/1b296904962709d06381523f39ccdffae775dd44/React/Base/RCTProfile.m#L183">Original RCTProfile implementation</a></li>
<li><a href="https://geekanddad.wordpress.com/2013/03/14/1636/">Objective-C method invocation benchmarks</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/#//apple_ref/c/func/objc_msgSend">objc_msgSend docs</a></li>
<li><a href="https://github.com/opensource-apple/objc4/blob/17d47b3989923007fa052f346b05a32fca389465/runtime/Messengers.subproj/objc-msg-x86_64.s#L289">objc_msgSend x86_64 implementation</a></li>
<li><a href="https://www.mikeash.com/pyblog/friday-qa-2012-11-16-lets-build-objc_msgsend.html">“Let’s Build objc_msgSend” by Mike Ash</a></li>
<li><a href="http://people.freebsd.org/~obrien/amd64-elf-abi.pdf">AMD64 ABI reference</a></li>
<li><a href="https://github.com/facebook/react-native/blob/master/React/Profiler/RCTProfileTrampoline-x86_64.S">Trampoline x86_64 full implementation</a></li>
</ul>
</div></div><div class="footer" data-reactid="12"><section class="share" data-reactid="13"><b data-reactid="14">Share:</b><a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;Writing a &#x27;trampoline&#x27; in assembly for profiling&quot; https://tadeuzagallo.com/blog/writing-a-trampoline-in-assembly/ via @tadeuzagallo&amp;hashtags=reactnative,ios,x86,asm" title="Share on Twitter" data-reactid="15"><i class="fa fa-lg fa-twitter" data-reactid="16"></i></a><a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://tadeuzagallo.com/blog/writing-a-trampoline-in-assembly/" title="Share on Facebook" data-reactid="17"><i class="fa fa-lg fa-facebook" data-reactid="18"></i></a><a aria-label="Share on Google Plus" href="https://plus.google.com/share?url=https://tadeuzagallo.com/blog/writing-a-trampoline-in-assembly/" title="Share on Google+" data-reactid="19"><i class="fa fa-lg fa-google-plus" data-reactid="20"></i></a></section><hr data-reactid="21"/><a href="https://twitter.com/tadeuzagallo" data-reactid="22"><img src="/blog/12790c3e14a70c6efd91375148aaf0ba.jpg" width="175" height="175" data-reactid="23"/><p data-reactid="24"><small data-reactid="25">Author</small></p><p data-reactid="26"><b data-reactid="27">Tadeu Zagallo</b></p><em data-reactid="28">I&#x27;m a Software Engineer. I like programming languages, VMs &amp; compilers. I work at Uber. I did some React Native stuff at Facebook.</em></a><hr data-reactid="29"/><div title="Writing a &#x27;trampoline&#x27; in assembly for profiling" data-reactid="30"><div id="disqus_thread" data-reactid="31"></div><noscript data-reactid="32"><span data-reactid="33"><!-- react-text: 34 -->Please enable JavaScript to view the<!-- /react-text --><a href="http://disqus.com/?ref_noscript" data-reactid="35">comments powered by Disqus.</a></span></noscript><a href="http://disqus.com" class="dsq-brlink" data-reactid="36"><!-- react-text: 37 -->Blog comments powered by <!-- /react-text --><span class="logo-disqus" data-reactid="38">Disqus</span><!-- react-text: 39 -->.<!-- /react-text --></a></div></div></div></div></div></div></div><script src="/blog/bundle.js?t=1480209960648"></script></body></html>